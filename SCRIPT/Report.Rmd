---
title: "Report_test"
author: "toprak"
date: "`r Sys.Date()`"
output: html_document
---


## Original data

The data comes from randomized trial,
[here are details](https://github.com/toprakd/group5/blob/main/DATA/codebook_updated)


### READING DATA ---- 
```{r include=FALSE}
library(tidyverse)
# install.packages("tidyverse")
library(here)

#read data
exam_nontidy <- read_delim(here("DATA", "exam_nontidy.txt"))
```


```{r}
exam_nontidy
```

## TIDYING THE DATA
  to tidy the data, we had to:
- remove duplicated rows
- rename coloumns that contain spaces or start with numbers.
- separate subject and pregnancy_num-age coloumns into two
- create to new coloums called glucose_mg_dl and dbp_mm_hg because the .value coloumn was including values from both features.

```{r} 
#Changing the names of coloumns
exam_nontidy <- 
  exam_nontidy %>% 
  rename(insulin_microiu_ml = `insulin microiu ml`,
         diabetes_5_year = `5y diabetes`,
         cholesterol = choleste)

#Separate variable subject into hospital and ID:
df <- separate(exam_nontidy, subject, sep ="-",
               into = c("hospital", "ID"))

#Separate variable pregnancy_num-age into pregnancy_num and age:
df1 <- separate(df, "pregnancy_num-age", sep ="-",
                into = c("preg_num", "age"))

#remove duplicates and pivot wider (for the measured variable and the .value coloumn)
tidy_data <- df1 %>%
  distinct() %>%   #remove duplicates 
  pivot_wider(names_from = `measured variable`, 
              values_from = .value) #.value include values from 2 features/measurements
```


## WRANGLING ----
Read and join the additional dataset to your main dataset 
```{r}
join_data <- read.delim(here("DATA/exam_joindata.txt"))
join_data <- join_data %>%
  rename(ID = id)
```
Merge steps
- remove unnecessary "cholesterol" and "sibling" columns 
- adding a numeric column showing insulin in units pmol/L (1 microiu_ml = 6.945 pmol_l)
- adding a column showing `diabetes_5y` as 0/1
- adding a numeric column showing multiplication of `age` and `pregnancy_num` for each person
- Settin the order of columns as: `id, hospital, age` and other columns
- Arrange ID column of your dataset in order of increasing number or alphabetically

```{r}
tidy_data <- tidy_data %>% 
  select(- cholesterol, - sibling)  %>% 
  mutate(glucose_mg_dl_categoric = ifelse(glucose_mg_dl >120, "High", "Low"),
         insulin_pmol_L = insulin_microiu_ml * 6.945, 
         diabetes_5_year_binary= ifelse(diabetes_5_year== "neg",0,1),
         multiplication_age_and_pregnancy_num= preg_num*age) %>% 
  select(ID, hospital, age, everything()) %>% 
  arrange(ID) %>%
  full_join(join_data, join_by("ID")) 

tidy_data  %>% 
  group_by(hospital) %>% 
  summarise( min(preg_num), max(preg_num ), mean(preg_num),sd(preg_num ))

```

Summary and overview of our data 
```{r}
summary(tidy_data) 
glimpse(tidy_data)
skimr::skim(tidy_data)
```

Explore and comment on missing data 
```{r}
naniar::gg_miss_var(tidy_data)
```

Stratefying data 
```{r}
tidy_data %>%
  group_by(hospital) %>%
  summarise(min(preg_num), max(preg_num), mean(preg_num), sd(preg_num))
```

Diabetes 5 year pos 
```{r}
tidy_data %>%
  filter(diabetes_5_year_binary == 1) %>%
  group_by(hospital) %>%
  summarise(min(preg_num), max(preg_num), mean(preg_num), sd(preg_num))
```

Only for persons recruited in Hosp1 
```{r}
tidy_data  %>% 
  group_by(hospital) %>% 
  summarise( min(preg_num), max(preg_num ), mean(preg_num),sd(preg_num )) %>%
  filter(hospital == "Hosp1")
```

Only for persons with `pregnanyc_num` more than 2 
```{r}
tidy_data  %>% 
  filter(preg_num>2)%>% 
  group_by(hospital) %>% 
  summarise( min(preg_num), max(preg_num), mean(preg_num),sd(preg_num ))
```

`glucose_mg_dl` lower than 120 and `dbp_mm_hg` greater than 60
```{r}
tidy_data  %>% 
  filter(glucose_mg_dl < 120, dbp_mm_hg > 60) %>% 
  group_by(hospital) %>% 
  summarise( min(preg_num), max(preg_num ), mean(preg_num),sd(preg_num ))
```

Use two categorical columns in your dataset to create a table (hint: ?count)
```{r}
tidy_data %>%
  group_by(hospital, diabetes_5_year) %>%
  summarise(count = n())
```

```{r}
summary(tidy_data)
```
Triceps_mm, insulin_microiu_ml, and bmi has NA vaules


## PLOTS ----
```{r}
# Checking for correlated measurements, computing correlation matrix and plotting:

library(ggcorrplot)
numeric_data <- tidy_data %>%
  select(where(is.numeric))

corr <- cor(numeric_data, use = "complete.obs")

ggcorrplot(
  corr,
  method = "square",           
  type = "full",                #
  ggtheme = ggplot2::theme_minimal(),
  title = "Correlation Matrix",
  show.legend = TRUE,
  legend.title = "Corr",
  show.diag = TRUE,             
  colors = c("blue", "white", "red"),
  outline.color = "gray",
  hc.order = FALSE,             
  lab = TRUE,                   
  lab_col = "black",
  lab_size = 4,
  tl.cex = 12,                  
  tl.col = "black",
  tl.srt = 45,                  
  digits = 2                   
)
```
- In the correlation matrix we mostly saw positive correlation. And especially, glucose_mg_dl and insulin_microiu_ml correalated, and bmi and triceps_mm were correlated.
```{r}
# Examine if the level of glucose and insulin depend on each other:

ggplot(data = tidy_data) +
  aes(
    x = glucose_mg_dl,
    y = insulin_microiu_ml
  ) +
  geom_point()+
  geom_smooth(method = "lm")
```
- The glucose and insulin level seems to be dependent on each other.
```{r}
# Examine if the level of glucose and insulin depend on each other, when stratifying by outcome (`diabetes_5_year`):
ggplot(data = tidy_data) +
  aes(
    x = glucose_mg_dl,
    y = insulin_microiu_ml
  ) +
  geom_point(
    aes(color = diabetes_5_year,
        shape = diabetes_5_year),
    size = 2 
  ) +
  geom_smooth(
    method = "lm",
    se = FALSE,
    aes(color = diabetes_5_year)
  )
```
- The level of glucose and insulin depend in both 5 year diabetes positive and negative patients, but the correlation looks stronger in diabetes negative patients. 
```{r}
#Examine the correlation between glucose and blood pressure: 
ggplot(data = tidy_data) +
  aes(
    x = glucose_mg_dl,
    y = dbp_mm_hg
  ) +
  geom_point() +
  geom_smooth(method = "lm")
```
- There does not seem to be strong correlation between glucose and blood pressure.
```{r}
# Examine the relation between the `BMI` and `triceps_mm` values:
ggplot(data = tidy_data) +
  aes(
    x = bmi,
    y = triceps_mm
  ) +
  geom_point() +
  geom_smooth(method = "lm")
```
- There was a strong relationship between BMI and triceps_mm.
```{r}
# Examine the blood pressure distribution in different BMI categories:

# Creating BMI categories:
tidy_data <- tidy_data %>%
  mutate(
    bmi_category = case_when(
      bmi < 25 ~ "healthy_weight",
      bmi >= 25 & bmi < 30 ~ "over_weight",
      bmi >= 30 ~ "obesity"
    ),
    # Order of levels:
    bmi_category = factor(bmi_category, levels = c("healthy_weight", "over_weight", "obesity"))
  )

# Plotting:
ggplot(data = tidy_data) +
  aes(
    x = bmi_category,
    y = dbp_mm_hg
  ) +
  geom_boxplot()
```
- Blood pressure distributions tend to increase with higher obesity levels based on BMI categories. In patients with unknown BMI values, the pattern closely resembles that of the obesity group.


## STATISTICAL ANALYSIS ----
```{r}
tidy_data %>% 
  kruskal.test(diabetes_5_year~pedigree, data = .) %>%
  broom::tidy()
```
The effect of pedigree on diabetes outcome was not statistically significant so diabetes does not seems to be effected by pedigree  

```{r}
tidy_data %>% 
  kruskal.test(diabetes_5_year~bmi, data = .) %>%
  broom::tidy()
```
The effect of BMI on diabetes was statistically significant so diabetes seems to be effected by BMI

```{r}
tidy_data %>% 
  kruskal.test(diabetes_5_year~glucose_mg_dl, data = .) %>%
  broom::tidy()
```
The effect of glucose_mg_dl on diabetes was statistically significant so so diabetes seems to be effected by glucose levels 

```{r}
tidy_data %>% 
  kruskal.test(diabetes_5_year~hospital, data = .) %>%
  broom::tidy()
```
The effect of hospital on diabetes was not statistically significant so diabetes seems to be effected by hospital







